{% extends 'base.html.twig' %}

{% block title %}{{ pageTitle }}{% endblock %}

{% block body %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ pageTitle }}</h1>
        <div class="btn-group">
            {% if isAdmin %}
                <a href="{{ path('admin_stats') }}" class="btn btn-primary">
                    <i class="fas fa-chart-bar me-1"></i> Statistiques
                </a>
            {% endif %}
            {% if not isAdmin %}
                <a href="{{ path('app_evenement_index') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Nouvelle réservation
                </a>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="{{ path('app_reservation_my') }}" class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label">Recherche</label>
                    <input
                        type="text"
                        name="q"
                        class="form-control"
                        value="{{ filter_input.q|default('') }}"
                        placeholder="Evenement, lieu, participant"
                    >
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Date debut</label>
                    <input
                        type="date"
                        name="date_start"
                        class="form-control"
                        value="{{ filter_input.date_start|default('') }}"
                    >
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Date fin</label>
                    <input
                        type="date"
                        name="date_end"
                        class="form-control"
                        value="{{ filter_input.date_end|default('') }}"
                    >
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Statut</label>
                    <select name="status" class="form-select">
                        <option value="" {{ filter_input.status|default('') == '' ? 'selected' : '' }}>Tous</option>
                        <option value="CONFIRMED" {{ filter_input.status|default('') == 'CONFIRMED' ? 'selected' : '' }}>CONFIRMED</option>
                        <option value="CANCELLED" {{ filter_input.status|default('') == 'CANCELLED' ? 'selected' : '' }}>CANCELLED</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Tri</label>
                    <select name="sort" class="form-select">
                        <option value="date_desc" {{ filter_input.sort|default('date_desc') == 'date_desc' ? 'selected' : '' }}>
                            Reservation (recent -> ancien)
                        </option>
                        <option value="date_asc" {{ filter_input.sort|default('date_desc') == 'date_asc' ? 'selected' : '' }}>
                            Reservation (ancien -> recent)
                        </option>
                        <option value="event_date_desc" {{ filter_input.sort|default('date_desc') == 'event_date_desc' ? 'selected' : '' }}>
                            Evenement (recent -> ancien)
                        </option>
                        <option value="event_date_asc" {{ filter_input.sort|default('date_desc') == 'event_date_asc' ? 'selected' : '' }}>
                            Evenement (ancien -> recent)
                        </option>
                    </select>
                </div>
                <div class="col-12 col-md-3 d-flex gap-2">
                    <button class="btn btn-primary">Filtrer</button>
                    <a class="btn btn-outline-secondary" href="{{ path('app_reservation_my') }}">Reinitialiser</a>
                </div>
            </form>
        </div>
    </div>

    {% if reservations is empty %}
        <div class="alert alert-info">
            {% if isAdmin %}
                Aucune réservation n'a été effectuée pour le moment.
            {% else %}
                Vous n'avez aucune réservation pour le moment. 
                <a href="{{ path('app_evenement_index') }}">Voir les événements disponibles</a>.
            {% endif %}
        </div>
    {% else %}
        {% if isAdmin %}
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Événement</th>
                                <th>Participant</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                                <tr>
                                    <td>#{{ reservation.id }}</td>
                                    <td>{{ reservation.evenement.titre }}</td>
                                    <td>{{ reservation.participant.prenom }} {{ reservation.participant.nom }}</td>
                                    <td>{{ reservation.evenement.dateDebut|date('d/m/Y H:i') }}</td>
                                    <td>
                                        <form method="post" 
                                              action="{{ path('app_reservation_cancel', {'id': reservation.id}) }}" 
                                              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette réservation ?');" 
                                              class="d-inline p-0">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="row">
                {% for reservation in reservations %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <span>{{ reservation.evenement.titre }}</span>
                                <span class="badge bg-light text-primary">Confirmée</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    <strong>Date de l'événement:</strong> {{ reservation.evenement.dateDebut|date('d/m/Y H:i') }}<br>
                                    <strong>Lieu:</strong> {{ reservation.evenement.lieu }}<br>
                                    <strong>Réservé le:</strong> {{ reservation.dateReservation|date('d/m/Y H:i') }}
                                </p>
                                <a href="{{ path('app_evenement_show', {'id': reservation.evenement.id}) }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye me-1"></i> Voir l'événement
                                </a>
                                
                                <form method="post" 
                                      action="{{ path('app_reservation_cancel', {'id': reservation.id}) }}" 
                                      onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette réservation ?');" 
                                      class="d-inline-block">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="fas fa-times me-1"></i> Annuler
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}

    {% if total_pages > 1 %}
        {% set query = filter_input|default({}) %}
        <nav class="mt-4" aria-label="Pagination">
            <ul class="pagination justify-content-center flex-wrap">
                <li class="page-item {{ page == 1 ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path('app_reservation_my', query|merge({page: page == 1 ? 1 : page - 1})) }}">Precedent</a>
                </li>
                {% for i in 1..total_pages %}
                    <li class="page-item {{ page == i ? 'active' : '' }}">
                        <a class="page-link" href="{{ path('app_reservation_my', query|merge({page: i})) }}">{{ i }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {{ page == total_pages ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path('app_reservation_my', query|merge({page: page == total_pages ? total_pages : page + 1})) }}">Suivant</a>
                </li>
            </ul>
        </nav>
    {% endif %}
{% endblock %}
