{% extends 'base.html.twig' %}

{% block title %}Événements{% endblock %}

{% block body %}
<div class="bo-page-header">
    <h1>
        <i class="fas fa-calendar-alt"></i> Événements
        <span class="badge bg-primary bg-opacity-75">{{ total }}</span>
    </h1>
    <div class="bo-actions">
        {% if is_granted('ROLE_ARTISTE') or is_granted('ROLE_ADMIN') %}
            <a href="{{ path('app_evenement_new') }}" class="btn btn-primary"><i class="fas fa-plus me-1"></i> Nouveau</a>
        {% endif %}
    </div>
</div>

<form method="get" action="{{ path('app_evenement_index') }}" class="bo-filter-bar">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
            <label>Recherche</label>
            <input type="text" name="q" class="form-control" value="{{ filter_input.q|default('') }}" placeholder="Titre, lieu, organisateur…">
        </div>
        <div class="col-6 col-md-2">
            <label>Lieu</label>
            <input type="text" name="lieu" class="form-control" value="{{ filter_input.lieu|default('') }}" placeholder="Ville / lieu">
        </div>
        <div class="col-6 col-md-2">
            <label>Date début</label>
            <input type="date" name="date_start" class="form-control" value="{{ filter_input.date_start|default('') }}">
        </div>
        <div class="col-6 col-md-2">
            <label>Date fin</label>
            <input type="date" name="date_end" class="form-control" value="{{ filter_input.date_end|default('') }}">
        </div>
        <div class="col-6 col-md-3">
            <label>Tri</label>
            <select name="sort" class="form-select">
                <option value="date_asc" {{ filter_input.sort == 'date_asc' ? 'selected' }}>Date ↑</option>
                <option value="date_desc" {{ filter_input.sort == 'date_desc' ? 'selected' }}>Date ↓</option>
                <option value="prix_asc" {{ filter_input.sort == 'prix_asc' ? 'selected' }}>Prix ↑</option>
                <option value="prix_desc" {{ filter_input.sort == 'prix_desc' ? 'selected' }}>Prix ↓</option>
                <option value="titre_asc" {{ filter_input.sort == 'titre_asc' ? 'selected' }}>Titre A→Z</option>
                <option value="titre_desc" {{ filter_input.sort == 'titre_desc' ? 'selected' }}>Titre Z→A</option>
            </select>
        </div>
        <div class="col-6 col-md-1">
            <label>Prix min</label>
            <input type="number" step="0.01" name="prix_min" class="form-control" value="{{ filter_input.prix_min|default('') }}" placeholder="0">
        </div>
        <div class="col-6 col-md-1">
            <label>Prix max</label>
            <input type="number" step="0.01" name="prix_max" class="form-control" value="{{ filter_input.prix_max|default('') }}" placeholder="∞">
        </div>
        <div class="col-12 col-md-4 col-lg-3 d-flex gap-2">
            <button class="btn btn-primary flex-grow-1"><i class="fas fa-search me-1"></i> Filtrer</button>
            <a class="btn btn-outline-secondary" href="{{ path('app_evenement_index') }}">Réinitialiser</a>
        </div>
    </div>
</form>

{% if is_granted('ROLE_ADMIN') %}
{# ===================== ADMIN TABLE VIEW ===================== #}
<div class="bo-table-card">
    {% if evenements is not empty %}
        <div class="table-responsive">
            <table class="table bo-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Événement</th>
                        <th>Date</th>
                        <th>Lieu</th>
                        <th>Places</th>
                        <th>Prix</th>
                        <th>Organisateur</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for ev in evenements %}
                    <tr>
                        <td class="text-muted">{{ ev.id }}</td>
                        <td>
                            <div class="fw-semibold">{{ ev.titre }}</div>
                            <small class="text-muted">{{ ev.description|length > 60 ? ev.description|slice(0, 60) ~ '…' : ev.description }}</small>
                        </td>
                        <td style="white-space:nowrap;">
                            <div>{{ ev.dateDebut ? ev.dateDebut|date('d/m/Y') : '—' }}</div>
                            <small class="text-muted">{{ ev.dateDebut ? ev.dateDebut|date('H:i') : '' }}{{ ev.dateFin ? ' → ' ~ ev.dateFin|date('H:i') : '' }}</small>
                        </td>
                        <td>{{ ev.lieu }}</td>
                        <td>
                            <span class="badge bg-secondary bg-opacity-75">{{ ev.reservations|length }} / {{ ev.nbPlaces }}</span>
                        </td>
                        <td>
                            {% if ev.prix %}
                                <span class="fw-semibold">{{ ev.prix }} TND</span>
                            {% else %}
                                <span class="badge bg-success bg-opacity-75">Gratuit</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ ev.organisateur.prenom }} {{ ev.organisateur.nom|first }}.
                        </td>
                        <td class="text-end">
                            <div class="d-flex gap-1 justify-content-end">
                                <a href="{{ path('app_evenement_show', {id: ev.id}) }}" class="btn-action btn-view" title="Voir"><i class="fas fa-eye"></i></a>
                                <a href="{{ path('app_evenement_edit', {id: ev.id}) }}" class="btn-action btn-edit" title="Éditer"><i class="fas fa-pen"></i></a>
                                <form method="post" action="{{ path('app_evenement_delete', {id: ev.id}) }}" class="d-inline" onsubmit="return confirm('Supprimer cet événement ?')">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ ev.id) }}">
                                    <button class="btn-action btn-del" title="Supprimer"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        {% if total_pages > 1 %}
            {% set qp = filter_input|default({}) %}
            <div class="bo-pagination">
                <div class="page-info">Page {{ page }} sur {{ total_pages }} — {{ total }} résultat{{ total > 1 ? 's' }}</div>
                <nav>
                    <ul class="pagination">
                        <li class="page-item {{ page == 1 ? 'disabled' }}">
                            <a class="page-link" href="{{ path('app_evenement_index', qp|merge({page: page - 1})) }}"><i class="fas fa-chevron-left"></i></a>
                        </li>
                        {% for p in 1..total_pages %}
                            <li class="page-item {{ p == page ? 'active' }}">
                                <a class="page-link" href="{{ path('app_evenement_index', qp|merge({page: p})) }}">{{ p }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {{ page == total_pages ? 'disabled' }}">
                            <a class="page-link" href="{{ path('app_evenement_index', qp|merge({page: page + 1})) }}"><i class="fas fa-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
            </div>
        {% endif %}
    {% else %}
        <div class="bo-empty">
            <i class="fas fa-calendar-times"></i>
            <p>Aucun événement trouvé</p>
        </div>
    {% endif %}
</div>

{% else %}
{# ===================== FRONTOFFICE CARD VIEW ===================== #}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for ev in evenements %}
        <div class="col">
            <div class="card h-100 shadow-sm" style="border:none; border-radius:14px; overflow:hidden;">
                {% if ev.image %}
                    <img src="{{ ev.image }}" class="card-img-top" alt="{{ ev.titre }}" style="height:180px; object-fit:cover;">
                {% else %}
                    <div class="card-img-top d-flex align-items-center justify-content-center" style="height:180px; background:linear-gradient(135deg,var(--ac-sky),var(--ac-lavender));">
                        <i class="fas fa-palette" style="font-size:2.5rem; color:#fff; opacity:.7;"></i>
                    </div>
                {% endif %}
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-1">{{ ev.titre }}</h6>
                    <p class="text-muted small mb-2">{{ ev.description|length > 80 ? ev.description|slice(0, 80) ~ '…' : ev.description }}</p>
                    <div class="d-flex flex-wrap gap-1 mb-2">
                        <span class="badge bg-light text-dark"><i class="fas fa-map-marker-alt me-1 text-muted"></i>{{ ev.lieu }}</span>
                        <span class="badge bg-light text-dark"><i class="fas fa-clock me-1 text-muted"></i>{{ ev.dateDebut ? ev.dateDebut|date('d/m/Y H:i') : '—' }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold" style="color:var(--ac-mid);">{{ ev.prix ? ev.prix ~ ' TND' : 'Gratuit' }}</span>
                        <span class="small text-muted">{{ ev.reservations|length }}/{{ ev.nbPlaces }} places</span>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 pt-0 pb-3 px-3">
                    <a href="{{ path('app_evenement_show', {id: ev.id}) }}" class="btn btn-sm w-100" style="background:var(--ac-mid); color:#fff; border-radius:10px; font-weight:600;">
                        Voir détails
                    </a>
                    {% if app.user and (app.user == ev.organisateur) %}
                        <a href="{{ path('app_evenement_edit', {id: ev.id}) }}" class="btn btn-sm btn-outline-secondary w-100 mt-1" style="border-radius:10px;">Modifier</a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="col-12">
            <div class="text-center py-5 text-muted">
                <i class="fas fa-calendar-times" style="font-size:2rem;"></i>
                <p class="mt-2">Aucun événement trouvé</p>
            </div>
        </div>
    {% endfor %}
</div>

{% if total_pages > 1 %}
    {% set qp = filter_input|default({}) %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {{ page == 1 ? 'disabled' }}">
                <a class="page-link" href="{{ path('app_evenement_index', qp|merge({page: page - 1})) }}"><i class="fas fa-chevron-left"></i></a>
            </li>
            {% for p in 1..total_pages %}
                <li class="page-item {{ p == page ? 'active' }}">
                    <a class="page-link" href="{{ path('app_evenement_index', qp|merge({page: p})) }}">{{ p }}</a>
                </li>
            {% endfor %}
            <li class="page-item {{ page == total_pages ? 'disabled' }}">
                <a class="page-link" href="{{ path('app_evenement_index', qp|merge({page: page + 1})) }}"><i class="fas fa-chevron-right"></i></a>
            </li>
        </ul>
    </nav>
{% endif %}
{% endif %}
{% endblock %}
