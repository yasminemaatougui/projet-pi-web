{% extends 'base.html.twig' %}

{% block title %}Tableau de bord — Art Connect{% endblock %}

{% block body %}
<style>
    .dash-header { margin-bottom:1.25rem; }
    .dash-header h1 { font-family:'Sora',sans-serif; font-weight:700; font-size:1.4rem; color:var(--ac-deep); margin:0; }
    .dash-header p { color:#6b7280; font-size:.84rem; margin:.2rem 0 0; }

    .kpi-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:.75rem; margin-bottom:1.25rem; }
    .kpi { background:#fff; border-radius:14px; padding:1rem 1.1rem; box-shadow:0 2px 10px rgba(0,0,0,.04); border:1px solid #f0f0f0; position:relative; overflow:hidden; }
    .kpi-icon { position:absolute; top:.8rem; right:.8rem; font-size:1.4rem; opacity:.12; }
    .kpi-val { font-family:'Sora',sans-serif; font-weight:800; font-size:1.6rem; color:var(--ac-deep); line-height:1.1; }
    .kpi-label { font-size:.72rem; font-weight:600; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; margin-top:.25rem; }
    .kpi-sub { font-size:.7rem; color:#9ca3af; margin-top:.15rem; }
    .kpi-accent { border-left:3px solid; }

    .dash-row { display:grid; gap:1rem; margin-bottom:1rem; }
    .dash-2 { grid-template-columns:1fr 1fr; }
    .dash-3 { grid-template-columns:1fr 1fr 1fr; }
    .dash-2-1 { grid-template-columns:2fr 1fr; }
    @media(max-width:992px) { .dash-2,.dash-3,.dash-2-1 { grid-template-columns:1fr; } }

    .dash-card { background:#fff; border-radius:14px; padding:1.25rem; box-shadow:0 2px 10px rgba(0,0,0,.04); border:1px solid #f0f0f0; }
    .dash-card h5 { font-family:'Sora',sans-serif; font-weight:700; font-size:.9rem; color:var(--ac-deep); margin-bottom:.85rem; display:flex; align-items:center; gap:.4rem; }
    .dash-card h5 i { color:var(--ac-lavender); }

    .mini-table { width:100%; font-size:.8rem; }
    .mini-table th { font-weight:700; color:#6b7280; font-size:.7rem; text-transform:uppercase; letter-spacing:.03em; padding:.4rem .5rem; border-bottom:2px solid #f3f4f6; }
    .mini-table td { padding:.45rem .5rem; border-bottom:1px solid #f9fafb; color:#374151; }
    .mini-table tr:last-child td { border-bottom:none; }

    .progress-sm { height:6px; border-radius:3px; background:#f3f4f6; overflow:hidden; }
    .progress-sm-fill { height:100%; border-radius:3px; transition:width .4s; }

    .stat-ring { display:inline-flex; align-items:center; justify-content:center; width:54px; height:54px; border-radius:50%; position:relative; }
    .stat-ring svg { transform:rotate(-90deg); }
    .stat-ring-val { position:absolute; font-size:.7rem; font-weight:800; color:var(--ac-deep); }
</style>

<div class="dash-header">
    <h1><i class="fas fa-chart-line me-2" style="color:var(--ac-lavender);"></i> Tableau de bord</h1>
    <p>Vue d'ensemble de la plateforme Art Connect</p>
</div>

{# ===== KPI CARDS ===== #}
<div class="kpi-grid">
    <div class="kpi kpi-accent" style="border-color:var(--ac-mid);">
        <i class="fas fa-users kpi-icon" style="color:var(--ac-mid);"></i>
        <div class="kpi-val">{{ totalUsers }}</div>
        <div class="kpi-label">Utilisateurs</div>
        <div class="kpi-sub">+{{ newUsersThisMonth }} ce mois</div>
    </div>
    <div class="kpi kpi-accent" style="border-color:var(--ac-blue);">
        <i class="fas fa-calendar-alt kpi-icon" style="color:var(--ac-blue);"></i>
        <div class="kpi-val">{{ eventStats.total }}</div>
        <div class="kpi-label">Événements</div>
        <div class="kpi-sub">{{ eventStats.upcoming }} à venir</div>
    </div>
    <div class="kpi kpi-accent" style="border-color:#22c55e;">
        <i class="fas fa-ticket-alt kpi-icon" style="color:#22c55e;"></i>
        <div class="kpi-val">{{ totalReservations }}</div>
        <div class="kpi-label">Réservations</div>
        <div class="kpi-sub">+{{ reservationsThisMonth }} ce mois</div>
    </div>
    <div class="kpi kpi-accent" style="border-color:var(--ac-lavender);">
        <i class="fas fa-shopping-bag kpi-icon" style="color:var(--ac-lavender);"></i>
        <div class="kpi-val">{{ totalOrders }}</div>
        <div class="kpi-label">Commandes</div>
        <div class="kpi-sub">{{ totalProducts }} produits</div>
    </div>
    <div class="kpi kpi-accent" style="border-color:var(--ac-pink);">
        <i class="fas fa-hand-holding-heart kpi-icon" style="color:var(--ac-pink);"></i>
        <div class="kpi-val">{{ totalDonations }}</div>
        <div class="kpi-label">Donations</div>
    </div>
    <div class="kpi kpi-accent" style="border-color:#f59e0b;">
        <i class="fas fa-comments kpi-icon" style="color:#f59e0b;"></i>
        <div class="kpi-val">{{ totalForumPosts }}</div>
        <div class="kpi-label">Forum</div>
        <div class="kpi-sub">discussions</div>
    </div>
</div>

{# ===== ROW 1: Event Stats + Revenue ===== #}
<div class="dash-row dash-2-1">
    <div class="dash-card">
        <h5><i class="fas fa-calendar-check"></i> Événements — Vue globale</h5>
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:.75rem; text-align:center;">
            <div>
                <div style="font-size:1.3rem; font-weight:800; color:var(--ac-blue);">{{ eventStats.upcoming }}</div>
                <div style="font-size:.7rem; color:#6b7280; font-weight:600;">À VENIR</div>
            </div>
            <div>
                <div style="font-size:1.3rem; font-weight:800; color:#22c55e;">{{ eventStats.ongoing }}</div>
                <div style="font-size:.7rem; color:#6b7280; font-weight:600;">EN COURS</div>
            </div>
            <div>
                <div style="font-size:1.3rem; font-weight:800; color:#9ca3af;">{{ eventStats.past }}</div>
                <div style="font-size:.7rem; color:#6b7280; font-weight:600;">TERMINÉS</div>
            </div>
            <div>
                <div style="font-size:1.3rem; font-weight:800; color:#ef4444;">{{ eventStats.full }}</div>
                <div style="font-size:.7rem; color:#6b7280; font-weight:600;">COMPLETS</div>
            </div>
        </div>
        <hr style="margin:.75rem 0;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem;">
            <div>
                <div style="font-size:.72rem; color:#6b7280; font-weight:600; text-transform:uppercase;">Taux d'occupation global</div>
                <div style="display:flex; align-items:center; gap:.6rem; margin-top:.3rem;">
                    <div class="progress-sm" style="flex:1;">
                        <div class="progress-sm-fill" style="width:{{ eventStats.occupancy }}%; background:linear-gradient(90deg,var(--ac-mid),var(--ac-blue));"></div>
                    </div>
                    <span style="font-weight:800; font-size:.85rem; color:var(--ac-deep);">{{ eventStats.occupancy }}%</span>
                </div>
                <div style="font-size:.7rem; color:#9ca3af; margin-top:.2rem;">{{ eventStats.totalTaken }} places prises sur {{ eventStats.totalPlaces }}</div>
            </div>
            <div>
                <div style="font-size:.72rem; color:#6b7280; font-weight:600; text-transform:uppercase;">Revenus événements</div>
                <div style="font-weight:800; font-size:1rem; color:#22c55e; margin-top:.3rem;">{{ eventStats.revenueActual|number_format(2, '.', ' ') }} TND</div>
                <div style="font-size:.7rem; color:#9ca3af;">Potentiel: {{ eventStats.revenuePotential|number_format(2, '.', ' ') }} TND</div>
            </div>
        </div>
    </div>

    <div class="dash-card">
        <h5><i class="fas fa-trophy"></i> Top événements</h5>
        {% if topEvents|length > 0 %}
            {% for item in topEvents %}
            <div style="display:flex; align-items:center; gap:.6rem; margin-bottom:.6rem; {% if not loop.last %}padding-bottom:.6rem; border-bottom:1px solid #f3f4f6;{% endif %}">
                <span style="width:22px; height:22px; border-radius:50%; background:{% if loop.index <= 3 %}linear-gradient(135deg,var(--ac-mid),var(--ac-blue)){% else %}#e5e7eb{% endif %}; color:{% if loop.index <= 3 %}#fff{% else %}#6b7280{% endif %}; display:flex; align-items:center; justify-content:center; font-size:.65rem; font-weight:800; flex-shrink:0;">{{ loop.index }}</span>
                <div style="flex:1; min-width:0;">
                    <div style="font-weight:700; font-size:.8rem; color:#1f2937; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ item.event.titre }}</div>
                    <div style="font-size:.68rem; color:#9ca3af;">{{ item.event.lieu }}</div>
                </div>
                <span class="badge bg-primary bg-opacity-75" style="font-size:.68rem;">{{ item.reservations }} rés.</span>
            </div>
            {% endfor %}
        {% else %}
            <div style="color:#9ca3af; font-size:.82rem; text-align:center; padding:1rem 0;">Aucun événement</div>
        {% endif %}
    </div>
</div>

{# ===== ROW 2: Charts ===== #}
<div class="dash-row dash-2">
    <div class="dash-card">
        <h5><i class="fas fa-chart-bar"></i> Réservations mensuelles</h5>
        <div style="height:220px;">
            <canvas id="monthlyResChart"></canvas>
        </div>
    </div>
    <div class="dash-card">
        <h5><i class="fas fa-chart-area"></i> Inscriptions mensuelles</h5>
        <div style="height:220px;">
            <canvas id="monthlyRegChart"></canvas>
        </div>
    </div>
</div>

{# ===== ROW 3: Users + Reservations breakdown ===== #}
<div class="dash-row dash-3">
    <div class="dash-card">
        <h5><i class="fas fa-user-tag"></i> Utilisateurs par rôle</h5>
        <div style="height:180px; margin-bottom:.75rem;">
            <canvas id="usersRoleChart"></canvas>
        </div>
        <table class="mini-table">
            <thead><tr><th>Rôle</th><th style="text-align:right;">Nb</th><th style="text-align:right;">%</th></tr></thead>
            <tbody>
                {% set uTotal = usersByRole|reduce((s,u) => s + u.count, 0) %}
                {% for u in usersByRole %}
                <tr>
                    <td>
                        {% if u.role == 'ROLE_ADMIN' %}<span class="badge bg-danger" style="font-size:.68rem;">Admin</span>
                        {% elseif u.role == 'ROLE_ARTISTE' %}<span class="badge bg-primary" style="font-size:.68rem;">Artiste</span>
                        {% elseif u.role == 'ROLE_PARTICIPANT' %}<span class="badge bg-success" style="font-size:.68rem;">Participant</span>
                        {% else %}<span class="badge bg-secondary" style="font-size:.68rem;">{{ u.role|replace({'ROLE_':''})|title }}</span>
                        {% endif %}
                    </td>
                    <td style="text-align:right; font-weight:700;">{{ u.count }}</td>
                    <td style="text-align:right; color:#6b7280;">{{ uTotal > 0 ? ((u.count / uTotal) * 100)|round(1) : 0 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="dash-card">
        <h5><i class="fas fa-clipboard-list"></i> Réservations par statut</h5>
        <div style="height:180px; margin-bottom:.75rem;">
            <canvas id="resStatusChart"></canvas>
        </div>
        <table class="mini-table">
            <thead><tr><th>Statut</th><th style="text-align:right;">Nb</th><th style="text-align:right;">%</th></tr></thead>
            <tbody>
                {% set rTotal = reservationsByStatus|reduce((s,r) => s + r.count, 0) %}
                {% for r in reservationsByStatus %}
                <tr>
                    <td>
                        {% if r.status == 'CONFIRMED' %}<span class="badge bg-success" style="font-size:.68rem;">Confirmé</span>
                        {% elseif r.status == 'CANCELLED' %}<span class="badge bg-danger" style="font-size:.68rem;">Annulé</span>
                        {% elseif r.status == 'PENDING' %}<span class="badge bg-warning text-dark" style="font-size:.68rem;">En attente</span>
                        {% else %}<span class="badge bg-secondary" style="font-size:.68rem;">{{ r.status }}</span>
                        {% endif %}
                    </td>
                    <td style="text-align:right; font-weight:700;">{{ r.count }}</td>
                    <td style="text-align:right; color:#6b7280;">{{ rTotal > 0 ? ((r.count / rTotal) * 100)|round(1) : 0 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="dash-card">
        <h5><i class="fas fa-calendar-plus"></i> Événements mensuels</h5>
        <div style="height:180px; margin-bottom:.75rem;">
            <canvas id="monthlyEvChart"></canvas>
        </div>
        <table class="mini-table">
            <thead><tr><th>Mois</th><th style="text-align:right;">Créés</th></tr></thead>
            <tbody>
                {% for m in monthlyEvents %}
                <tr>
                    <td>{{ m.month }}</td>
                    <td style="text-align:right; font-weight:700;">{{ m.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var font = { family: "'Manrope', sans-serif" };
    Chart.defaults.font.family = font.family;
    Chart.defaults.font.size = 11;

    var colors = {
        deep: '#1E0F75', mid: '#1C1DAB', blue: '#3785D8', lavender: '#BF8CE1',
        sky: '#ADC6E5', pink: '#EBB2C3', green: '#22c55e', red: '#ef4444', amber: '#f59e0b', gray: '#9ca3af'
    };

    // Monthly Reservations Bar
    new Chart(document.getElementById('monthlyResChart'), {
        type: 'bar',
        data: {
            labels: {{ monthlyReservations|map(m => m.month)|json_encode|raw }},
            datasets: [{
                label: 'Réservations',
                data: {{ monthlyReservations|map(m => m.count)|json_encode|raw }},
                backgroundColor: colors.blue + '88',
                borderColor: colors.blue,
                borderWidth: 1.5,
                borderRadius: 6,
                barPercentage: 0.6
            }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}} }
    });

    // Monthly Registrations Line
    new Chart(document.getElementById('monthlyRegChart'), {
        type: 'line',
        data: {
            labels: {{ monthlyRegistrations|map(m => m.month)|json_encode|raw }},
            datasets: [{
                label: 'Inscriptions',
                data: {{ monthlyRegistrations|map(m => m.count)|json_encode|raw }},
                borderColor: colors.lavender,
                backgroundColor: colors.lavender + '22',
                borderWidth: 2.5,
                fill: true,
                tension: 0.35,
                pointBackgroundColor: colors.lavender,
                pointRadius: 4
            }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}} }
    });

    // Users by Role Doughnut
    new Chart(document.getElementById('usersRoleChart'), {
        type: 'doughnut',
        data: {
            labels: {{ usersByRole|map(u => u.role|replace({'ROLE_': ''})|title)|json_encode|raw }},
            datasets: [{ data: {{ usersByRole|map(u => u.count)|json_encode|raw }}, backgroundColor: [colors.red, colors.blue, colors.green, colors.amber], borderWidth: 0 }]
        },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{legend:{display:false}} }
    });

    // Reservations by Status Doughnut
    new Chart(document.getElementById('resStatusChart'), {
        type: 'doughnut',
        data: {
            labels: {{ reservationsByStatus|map(r => r.status)|json_encode|raw }},
            datasets: [{ data: {{ reservationsByStatus|map(r => r.count)|json_encode|raw }}, backgroundColor: [colors.green, colors.amber, colors.red, colors.gray], borderWidth: 0 }]
        },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{legend:{display:false}} }
    });

    // Monthly Events Bar
    new Chart(document.getElementById('monthlyEvChart'), {
        type: 'bar',
        data: {
            labels: {{ monthlyEvents|map(m => m.month)|json_encode|raw }},
            datasets: [{
                label: 'Événements',
                data: {{ monthlyEvents|map(m => m.count)|json_encode|raw }},
                backgroundColor: colors.lavender + '88',
                borderColor: colors.lavender,
                borderWidth: 1.5,
                borderRadius: 6,
                barPercentage: 0.6
            }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}} }
    });
});
</script>
{% endblock %}
